<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stress Tester</title>
    <link rel="stylesheet" href="%DIFF2HTML_CSS%">
    <link rel="stylesheet" href="%WEBVIEW_CSS%">
</head>
<body>
    <div id="initial-view">
        <p>Please open a <code>.cpp</code> file to begin.</p>
    </div>

    <div id="actions-view" class="hidden">
        <div id="file-info"></div>
        <div id="generate-view">
            <button id="generate-button">Create Stress Test Files</button>
        </div>
        <div id="run-view" class="hidden">
            <label for="num-tests-input">Number of Tests:</label>
            <input type="number" id="num-tests-input" value="100" min="1">
            <button id="run-button">Run Stress Test</button>
            <button id="view-runs-button">View Runs</button>
        </div>
    </div>
    
    <div id="results-view"></div>
    <div id="runs-view"></div>
    <div id="test-cases-view"></div>

    <script src="%DIFF2HTML_JS%"></script>
    <script nonce="%NONCE%">
        const vscode = acquireVsCodeApi();
        const initialView = document.getElementById('initial-view');
        const actionsView = document.getElementById('actions-view');
        const generateView = document.getElementById('generate-view');
        const runView = document.getElementById('run-view');
        const fileInfo = document.getElementById('file-info');
        const resultsView = document.getElementById('results-view');
        const numTestsInput = document.getElementById('num-tests-input');
        const runsView = document.getElementById('runs-view');
        const testCasesView = document.getElementById('test-cases-view');

        document.getElementById('generate-button').addEventListener('click', () => {
            vscode.postMessage({ command: 'generate' });
        });
        document.getElementById('run-button').addEventListener('click', () => {
            const numTests = parseInt(numTestsInput.value, 10);
            if (isNaN(numTests) || numTests <= 0) {
                numTestsInput.style.borderColor = 'red';
                return;
            }
            numTestsInput.style.borderColor = 'var(--vscode-input-border)';
            vscode.postMessage({ command: 'run', numTests: numTests });
        });
        document.getElementById('view-runs-button').addEventListener('click', () => {
            vscode.postMessage({ command: 'get-runs' });
        });

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'show-initial-state':
                    initialView.classList.remove('hidden');
                    actionsView.classList.add('hidden');
                    break;
                case 'update-view':
                    initialView.classList.add('hidden');
                    actionsView.classList.remove('hidden');
                    fileInfo.innerHTML = 'Testing: <code>' + message.solutionFilename + '</code>';
                    if (message.testFileExists) {
                        generateView.classList.add('hidden');
                        runView.classList.remove('hidden');
                    } else {
                        generateView.classList.remove('hidden');
                        runView.classList.add('hidden');
                    }
                    break;
                case 'test-running':
                    resultsView.innerHTML = '<p>Running tests...</p>';
                    runsView.innerHTML = '';
                    testCasesView.innerHTML = '';
                    break;
                case 'testResult':
                    let resultHtml = '';
                    switch(message.status) {
                        case 'Running':
                            resultsView.innerHTML = `<p>Running test #${message.testCase}...</p>`;
                            return;
                        case 'OK':
                            resultsView.innerHTML = `<p style="color: green;">Test #${message.testCase} Passed</p>`;
                            break;
                        case 'WA':
                            resultHtml += `<p style="color: red;">Wrong Answer on test #${message.testCase}</p>`;
                            resultHtml += '<strong>Input:</strong><pre>' + message.input + '</pre>';
                            resultHtml += '<strong>Your Output:</strong><pre>' + message.output + '</pre>';
                            resultsView.innerHTML = resultHtml;
                            break;
                        case 'TLE':
                            resultHtml += `<p style="color: orange;">Time Limit Exceeded on test #${message.testCase}</p>`;
                            resultHtml += '<strong>Input:</strong><pre>' + message.input + '</pre>';
                            resultsView.innerHTML = resultHtml;
                            break;
                        case 'MLE':
                            resultHtml += `<p style="color: orange;">Memory Limit Exceeded on test #${message.testCase}</p>`;
                            resultHtml += '<strong>Input:</strong><pre>' + message.input + '</pre>';
                            resultsView.innerHTML = resultHtml;
                            break;
                         case 'RUNTIME_ERROR':
                            resultHtml += `<p style="color: red;">Runtime Error on test #${message.testCase}</p>`;
                            resultHtml += '<strong>Input:</strong><pre>' + message.input + '</pre>';
                            if(message.message) resultHtml += '<strong>Error:</strong><pre>' + message.message + '</pre>';
                            resultsView.innerHTML = resultHtml;
                            break;
                        case 'Error':
                            resultHtml += '<p style="color: red;">Error</p>';
                            resultHtml += '<pre>' + message.message + '</pre>';
                            resultsView.innerHTML = resultHtml;
                            break;
                    }
                    break;
                case 'show-runs':
                    resultsView.innerHTML = '';
                    testCasesView.innerHTML = '';
                    let runsHtml = '<h3>Past Runs:</h3>';
                    if (message.runs.length === 0) {
                        runsHtml += '<p>No runs found for this solution.</p>';
                    } else {
                        message.runs.forEach(runId => {
                            runsHtml += `<div class="run-item" data-run-id="${runId}">${runId}</div>`;
                        });
                    }
                    runsView.innerHTML = runsHtml;
                    document.querySelectorAll('.run-item').forEach(item => {
                        item.addEventListener('click', event => {
                            const runId = event.target.getAttribute('data-run-id');
                            vscode.postMessage({ command: 'get-test-cases', runId: runId });
                        });
                    });
                    break;
                case 'show-test-cases':
                    testCasesView.innerHTML = '';
                    let testCasesHtml = `<h3>Test Cases for Run: ${message.runId}</h3>`;
                    if (message.testCases.length === 0) {
                        testCasesHtml += '<p>No test cases found for this run.</p>';
                    } else {
                        message.testCases.forEach(tc => {
                            const testCaseData = encodeURIComponent(JSON.stringify(tc));
                            testCasesHtml += `<div class="test-case-item">
                                <p><input type="checkbox" class="test-case-checkbox" data-test-case='${testCaseData}'><strong>Test Case #${tc.testCase}</strong></p>
                                <p>Result: ${tc.lastResult}</p>
                                <p>Time: ${tc.execTime} ms</p>
                                <p>Memory: ${tc.memoryUsed} KB</p>
                                <details>
                                    <summary>Details</summary>
                                    <p><strong>Input:</strong></p><pre>${tc.input}</pre>
                                    <p><strong>Output:</strong></p><pre>${tc.userOutput}</pre>
                                    ${tc.reason ? `<p><strong>Reason:</strong></p><pre>${tc.reason}</pre>` : ''}
                                    ${tc.message ? `<p><strong>Message:</strong></p><pre>${tc.message}</pre>` : ''}
                                </details>
                            </div>`;
                        });
                        testCasesHtml += '<button id="rerun-selected-button">Re-run Selected Tests</button>';
                    }
                    testCasesView.innerHTML = testCasesHtml;

                    const rerunButton = document.getElementById('rerun-selected-button');
                    if (rerunButton) {
                        rerunButton.addEventListener('click', () => {
                            const selectedTestCases = [];
                            document.querySelectorAll('.test-case-checkbox:checked').forEach(checkbox => {
                                selectedTestCases.push(JSON.parse(decodeURIComponent(checkbox.dataset.testCase)));
                            });

                            if (selectedTestCases.length > 0) {
                                const testCasesByRun = {
                                    [message.runId]: selectedTestCases
                                };
                                vscode.postMessage({ command: 'rerun-tests', testCases: testCasesByRun });
                            } else {
                                // Maybe show a message to the user that no tests are selected
                            }
                        });
                    }
                    break;
            }
        });

        vscode.postMessage({ command: 'webview-ready' });
    </script>
</body>
</html>
